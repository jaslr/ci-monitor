class r{eventSource=null;handlers=new Set;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=1e3;baseUrl=null;apiSecret=null;connect(e,t){this.eventSource&&this.disconnect(),this.baseUrl=e,this.apiSecret=t||null;const o=t?`${e}/events?secret=${encodeURIComponent(t)}`:`${e}/events`;try{this.eventSource=new EventSource(o),this.eventSource.onopen=()=>{console.log("[SSE] Connected to observatory-backend"),this.reconnectAttempts=0},this.eventSource.onmessage=n=>{try{const c=JSON.parse(n.data);this.notifyHandlers(c)}catch(c){console.error("[SSE] Failed to parse event:",c)}},this.eventSource.onerror=n=>{console.error("[SSE] Connection error:",n),this.handleReconnect()}}catch(n){console.error("[SSE] Failed to create EventSource:",n)}}handleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("[SSE] Max reconnect attempts reached, giving up");return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`[SSE] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.baseUrl&&this.connect(this.baseUrl,this.apiSecret||void 0)},e)}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null)}subscribe(e){return this.handlers.add(e),()=>{this.handlers.delete(e)}}notifyHandlers(e){for(const t of this.handlers)try{t(e)}catch(o){console.error("[SSE] Handler error:",o)}}get isConnected(){return this.eventSource?.readyState===EventSource.OPEN}get connectionStatus(){const e=this.eventSource?.readyState??-1,t=e===0?"Connecting":e===1?"Connected":e===2?"Closed":"Not initialized";return{connected:e===EventSource.OPEN,connecting:e===EventSource.CONNECTING,url:this.baseUrl,reconnectAttempts:this.reconnectAttempts,maxReconnectAttempts:this.maxReconnectAttempts,readyState:e,readyStateText:t}}}const i=new r;export{i as s};
